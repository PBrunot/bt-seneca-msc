<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Seneca MSC</title>
    <script src="./dist/bt-seneca-msc.js"></script>
</head>

<body>
    <style>
        .columns {
            Width: 100%;
        }

        .column {
            width: 100%;
        }

        @media (min-width: 48em) {
            .column {
                width: 50%;
                float: left;
            }

            .columns {
                content: "";
                display: table;
                clear: both;
            }
        }
    </style>
    <h1>API COMMANDS</h1>
    <table id="api" width="100%">
        <tr>
            <td><button id="startBt">Pair()</button></td>
            <td>
                <div id="resultPair"></div>
            </td>
            <td>Command type</td>
            <td>
                <select id="new_command_id">
                </select>
            </td>
        </tr>
        <tr>
            <td><button id="stopBt">Stop()</button></td>
            <td>
                <div id="resultStop"></div>
            </td>
            <td>Setpoint</td>
            <td><input type="number" id="new_command_sp" /></td>
        </tr>
        <tr>
            <td><button id="testBtn">Test</button></td>
            <td>
                <div id="resultPair"></div>
            </td>
            <td>Add</td>
            <td>
                <input type="button" id="executeBtn" value="Execute(command)">
                <div id="resultExecute"></div>
            </td>
        </tr>
    </table>
    <input type="button" id="traceBtn" value="Loglevel: debug" onclick="MSC.log.setLevel(MSC.log.levels.TRACE);">
    <input type="button" id="defaultLog" value="Loglevel: info" onclick="MSC.log.setLevel(MSC.log.levels.INFO);">
    <input type="button" id="defaultLog" value="Loglevel: default" onclick="MSC.log.setLevel(MSC.log.levels.WARN);">
    <br />
    </div>
    <h1>GetState()</h1>
    <div class="row">
        <div class="column">
            <table id="state" border="1">
                <tr>
                    <td>Status</td>
                    <td>
                        <div id="status"></div>
                    </td>
                </tr>
                <tr>
                    <td>Meter mode</td>
                    <td>
                        <div id="mode"></div>
                    </td>
                </tr>
                <tr>
                    <td>Last setpoint</td>
                    <td>
                        <div id="sp"></div>
                    </td>
                </tr>
                <tr>
                    <td>Last measure</td>
                    <td>
                        <div id="meas"></div>
                    </td>
                </tr>
                <tr>
                    <td>Bluetooth info</td>
                    <td>
                        <div id="btinfo"></div>
                    </td>
                </tr>
                <tr>
                    <td>Meter serial number</td>
                    <td>
                        <div id="serial"></div>
                    </td>
                </tr>
                <tr>
                    <td>Meter battery (V)</td>
                    <td>
                        <div id="battery"></div>
                    </td>
                </tr>
                <tr>
                    <td>Stats</td>
                    <td>
                        <div id="stats"></div>
                    </td>
                </tr>
            </table>
        </div>
        <div class="column">
            <img src="./docs/msc.jpg" alt="Seneca MSC" />
        </div>
    </div>
    <script>
        document.getElementById("startBt").onclick = async () => {
            document.getElementById("resultPair").innerHTML = "Pending...";
            var res = await MSC.Pair();
            document.getElementById("resultPair").innerHTML = "Result : " + res;
        };
        document.getElementById("stopBt").onclick = async () => {
            document.getElementById("resultStop").innerHTML = "Pending...";
            var res = await MSC.Stop();
            document.getElementById("resultStop").innerHTML = "Result : " + res;
        };
        document.getElementById("testBtn").onclick = async () => {
            test();
        };
        document.getElementById("executeBtn").onclick = async () => {
            await addRequest();
        };

        var select = document.getElementById("new_command_id");
        for (var i in MSC.CommandType) {
            var opt = document.createElement('option');
            opt.value = MSC.CommandType[i];
            opt.innerHTML = i;
            select.appendChild(opt);
        }

        function dumpArray(arr) {
            var elem = "";
            for (var key in arr) {
                elem += key + " = " + arr[key] + "<br/>";
            }
            return elem;
        }

        async function addRequest() {
            var type = parseInt(document.getElementById("new_command_id").value);
            var setpoint = document.getElementById("new_command_sp").value;
            const comm = new MSC.Command(type, setpoint);
            document.getElementById("resultExecute").innerHTML = "Pending...";
            var res = await MSC.Execute(comm);
            document.getElementById("resultExecute").innerHTML = "Result : " + res;
        }
        async function updateStatus() {
            var mstate = await MSC.GetState();
            document.getElementById("status").innerHTML = mstate.status;
            document.getElementById("sp").innerHTML = dumpArray(mstate.lastSetpoint);
            document.getElementById("meas").innerHTML = dumpArray(mstate.lastMeasure);
            document.getElementById("btinfo").innerHTML = mstate.deviceName;
            document.getElementById("serial").innerHTML = mstate.deviceSerial;
            document.getElementById("mode").innerHTML = mstate.deviceMode;
            document.getElementById("battery").innerHTML = mstate.batteryLevel;
            document.getElementById("stats").innerHTML = dumpArray(mstate.stats);
            setTimeout(updateStatus, 500);
        }
        setTimeout(updateStatus, 500);


        var cycle = [[MSC.CommandType.V, 0], [MSC.CommandType.mV, 0], [MSC.CommandType.mA_active, 0],
        [MSC.CommandType.mA_passive, 0], [MSC.CommandType.GEN_mV, 1], [MSC.CommandType.GEN_mV, 2],
        [MSC.CommandType.GEN_mA_active, 0], [MSC.CommandType.GEN_mA_active, 4], [MSC.CommandType.GEN_mA_active, 12],
        [MSC.CommandType.GEN_mA_active, 20], [MSC.CommandType.GEN_V, 0], [MSC.CommandType.GEN_V, 10]];

        async function test() {
            var len = cycle.length;
            var idx = 0;
            while (true) {
                var com = new MSC.Command(cycle[idx][0], cycle[idx][1]);
                var result = await MSC.Execute(com);
                log.info("** Result:" + result);
                console.assert(result.error == false);
                idx++;
                if (idx == len) idx = 0;
                await sleep(10000);
            }
        }

        async function demo() {
            var command = new MSC.Command(MSC.CommandType.mV); // Read mV
            var result = await MSC.Execute(command);
            if (result.error) {
                // Something happened with command execution (device off, comm error...)
                return;
            }
            var measure = MSC.GetState().lastMeasure;
            if (measure.error) {
                // Measure is not valid ; should retry 
            }
            else {
                console.log(measure); // Print the measurements
            }

            var command = new MSC.Command(MSC.CommandType.GEN_V, 5.2); // Generate 5.2 V
            var result = await MSC.Execute(command);
            if (result.error) {
                // Something happened with command execution (device off, comm error...)
                return;
            }
            var sp = await MSC.GetState().lastSetpoint;
            if (sp.error) {
                // Generation has error (e.g. short circuit, wrong connections...) 
            }
            else {
                console.log(sp); // Print the setpoint
            }
        }

        
    </script>
</body>

</html>